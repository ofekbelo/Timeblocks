// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER MODEL
// ==========================================
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  fullName      String   @map("full_name")
  avatarUrl     String?  @map("avatar_url")

  // Settings
  timezone      String   @default("Asia/Jerusalem")
  currency      String   @default("ILS")
  preferences   Json?

  // Email verification
  emailVerified         Boolean   @default(false) @map("email_verified")
  verificationToken     String?   @unique @map("verification_token")
  verificationExpires   DateTime? @map("verification_expires")

  // Password reset
  passwordResetToken    String?   @unique @map("password_reset_token")
  passwordResetExpires  DateTime? @map("password_reset_expires")

  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  clients       Client[]
  projects      Project[]
  timeEntries   TimeEntry[]
  refreshTokens RefreshToken[]

  @@map("users")
}

// ==========================================
// CLIENT MODEL
// ==========================================
model Client {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")

  // Client info
  name       String
  email      String?
  phone      String?
  address    String?  @db.Text
  color      String   @default("#4A90E2")
  notes      String?  @db.Text

  // Status
  isArchived Boolean  @default(false) @map("is_archived")

  // Timestamps
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects   Project[]

  @@index([userId])
  @@map("clients")
}

// ==========================================
// PROJECT MODEL
// ==========================================
model Project {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  clientId        String?   @map("client_id")

  // Project info
  name            String
  hourlyRate      Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  estimatedBudget Decimal?  @map("estimated_budget") @db.Decimal(10, 2)
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")

  // Status and appearance
  status          ProjectStatus @default(ACTIVE)
  color           String        @default("#4A90E2")
  isArchived      Boolean       @default(false) @map("is_archived")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client          Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  timeEntries     TimeEntry[]

  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

// ==========================================
// TIME ENTRY MODEL
// ==========================================
model TimeEntry {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  projectId   String    @map("project_id")

  // Entry details
  description String?   @db.Text
  startTime   DateTime  @map("start_time")
  endTime     DateTime? @map("end_time")
  duration    Int?      // Duration in seconds (calculated)

  // Metadata
  isManual    Boolean   @default(false) @map("is_manual")
  tags        String[]  @default([])

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([startTime])
  @@map("time_entries")
}

// ==========================================
// REFRESH TOKEN MODEL
// ==========================================
model RefreshToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")

  // Token info
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
