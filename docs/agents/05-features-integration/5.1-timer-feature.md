# Sub-Agent 5.1: Timer Feature

**Parent:** Agent 5 - Features Integration  
**Status:** Ready to Execute  
**Dependencies:** Agent 1-4  
**Estimated Time:** 3-4 hours  
**Working Directory:** `timeblocks/apps/web/`

---

## üìã Mission

Build a complete timer feature that allows users to track time in real-time, with automatic localStorage persistence and backend synchronization.

---

## üéØ What You'll Build

```
‚úÖ Timer Redux Slice
   - Active timer state
   - Real-time elapsed calculation
   - Start/Stop/Reset actions
   
‚úÖ Timer Component
   - Large, prominent display
   - Start/Stop button
   - Project selector
   - Description field
   
‚úÖ Timer Page
   - Timer controls
   - Recent entries list
   - Today's stats
   - Quick actions
   
‚úÖ Persistence
   - Save to localStorage on start
   - Restore on page load
   - Sync with backend API
```

---

## ‚úÖ Step-by-Step Tasks

### TASK 1: Update Timer Redux Slice

Update `src/store/slices/timerSlice.ts`:

```typescript
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import type { TimeEntry } from '@timeblocks/shared/types';

interface TimerState {
  activeTimer: {
    id: string | null;
    projectId: string | null;
    projectName: string | null;
    projectColor: string | null;
    description: string | null;
    startTime: string | null;
    elapsedSeconds: number;
  } | null;
  isRunning: boolean;
}

const loadTimerFromStorage = (): TimerState['activeTimer'] => {
  try {
    const stored = localStorage.getItem('activeTimer');
    if (stored) {
      const timer = JSON.parse(stored);
      // Calculate elapsed time since start
      const startTime = new Date(timer.startTime);
      const now = new Date();
      const elapsedSeconds = Math.floor((now.getTime() - startTime.getTime()) / 1000);
      return {
        ...timer,
        elapsedSeconds,
      };
    }
  } catch (error) {
    console.error('Failed to load timer from storage:', error);
  }
  return null;
};

const initialState: TimerState = {
  activeTimer: loadTimerFromStorage(),
  isRunning: !!loadTimerFromStorage(),
};

const timerSlice = createSlice({
  name: 'timer',
  initialState,
  reducers: {
    startTimer: (
      state,
      action: PayloadAction<{
        projectId: string;
        projectName: string;
        projectColor: string;
        description?: string;
      }>
    ) => {
      const startTime = new Date().toISOString();
      state.activeTimer = {
        id: null, // Will be set when synced with backend
        projectId: action.payload.projectId,
        projectName: action.payload.projectName,
        projectColor: action.payload.projectColor,
        description: action.payload.description || null,
        startTime,
        elapsedSeconds: 0,
      };
      state.isRunning = true;

      // Save to localStorage
      localStorage.setItem('activeTimer', JSON.stringify(state.activeTimer));
    },

    stopTimer: (state) => {
      state.activeTimer = null;
      state.isRunning = false;
      localStorage.removeItem('activeTimer');
    },

    updateElapsedTime: (state) => {
      if (state.activeTimer && state.isRunning) {
        const startTime = new Date(state.activeTimer.startTime!);
        const now = new Date();
        state.activeTimer.elapsedSeconds = Math.floor(
          (now.getTime() - startTime.getTime()) / 1000
        );
      }
    },

    updateDescription: (state, action: PayloadAction<string>) => {
      if (state.activeTimer) {
        state.activeTimer.description = action.payload;
        // Update localStorage
        localStorage.setItem('activeTimer', JSON.stringify(state.activeTimer));
      }
    },

    setTimerId: (state, action: PayloadAction<string>) => {
      if (state.activeTimer) {
        state.activeTimer.id = action.payload;
        localStorage.setItem('activeTimer', JSON.stringify(state.activeTimer));
      }
    },
  },
});

export const {
  startTimer,
  stopTimer,
  updateElapsedTime,
  updateDescription,
  setTimerId,
} = timerSlice.actions;

export default timerSlice.reducer;
```

---

### TASK 2: Create Timer Component

Create `src/pages/Timer/components/TimerControls/TimerControls.tsx`:

```typescript
import { useEffect, useState } from 'react';
import { useAppSelector, useAppDispatch } from '@/store/hooks';
import {
  startTimer,
  stopTimer,
  updateElapsedTime,
  updateDescription,
} from '@/store/slices/timerSlice';
import {
  useStartTimerMutation,
  useStopTimerMutation,
  useGetProjectsQuery,
} from '@/store/api';
import { formatDuration } from '@timeblocks/shared/utils';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import styles from './TimerControls.module.scss';

export function TimerControls() {
  const dispatch = useAppDispatch();
  const { activeTimer, isRunning } = useAppSelector((state) => state.timer);
  
  const { data: projects = [] } = useGetProjectsQuery();
  const [startTimerApi] = useStartTimerMutation();
  const [stopTimerApi] = useStopTimerMutation();

  const [selectedProjectId, setSelectedProjectId] = useState<string>('');
  const [description, setDescription] = useState('');

  // Update elapsed time every second when timer is running
  useEffect(() => {
    if (!isRunning) return;

    const interval = setInterval(() => {
      dispatch(updateElapsedTime());
    }, 1000);

    return () => clearInterval(interval);
  }, [isRunning, dispatch]);

  const handleStart = async () => {
    if (!selectedProjectId) {
      alert('Please select a project');
      return;
    }

    const project = projects.find((p) => p.id === selectedProjectId);
    if (!project) return;

    // Start timer in Redux
    dispatch(
      startTimer({
        projectId: project.id,
        projectName: project.name,
        projectColor: project.color,
        description,
      })
    );

    // Sync with backend
    try {
      const result = await startTimerApi({
        projectId: selectedProjectId,
        description: description || undefined,
      }).unwrap();

      // Store the backend ID
      dispatch({ type: 'timer/setTimerId', payload: result.id });
    } catch (error) {
      console.error('Failed to start timer on backend:', error);
    }
  };

  const handleStop = async () => {
    // Stop timer in Redux
    dispatch(stopTimer());

    // Sync with backend
    try {
      await stopTimerApi().unwrap();
    } catch (error) {
      console.error('Failed to stop timer on backend:', error);
    }

    // Clear form
    setDescription('');
  };

  const handleDescriptionChange = (value: string) => {
    setDescription(value);
    if (isRunning) {
      dispatch(updateDescription(value));
    }
  };

  return (
    <div className={styles.timerControls}>
      <div className={styles.display}>
        <div
          className={styles.timer}
          style={{
            borderColor: activeTimer?.projectColor || '#4A90E2',
          }}
        >
          <span className={styles.time}>
            {formatDuration(activeTimer?.elapsedSeconds || 0)}
          </span>
          {activeTimer && (
            <span className={styles.projectName}>
              {activeTimer.projectName}
            </span>
          )}
        </div>
      </div>

      <div className={styles.controls}>
        {!isRunning ? (
          <>
            <div className={styles.field}>
              <label>Project</label>
              <select
                value={selectedProjectId}
                onChange={(e) => setSelectedProjectId(e.target.value)}
                className={styles.select}
              >
                <option value="">Select a project...</option>
                {projects.map((project) => (
                  <option key={project.id} value={project.id}>
                    {project.name}
                  </option>
                ))}
              </select>
            </div>

            <div className={styles.field}>
              <label>Description (optional)</label>
              <Input
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="What are you working on?"
                fullWidth
              />
            </div>

            <Button
              variant="primary"
              size="lg"
              fullWidth
              onClick={handleStart}
              disabled={!selectedProjectId}
            >
              ‚ñ∂Ô∏è Start Timer
            </Button>
          </>
        ) : (
          <>
            <div className={styles.field}>
              <label>Description</label>
              <Input
                value={description}
                onChange={(e) => handleDescriptionChange(e.target.value)}
                placeholder="What are you working on?"
                fullWidth
              />
            </div>

            <Button
              variant="danger"
              size="lg"
              fullWidth
              onClick={handleStop}
            >
              ‚èπÔ∏è Stop Timer
            </Button>
          </>
        )}
      </div>
    </div>
  );
}
```

Create `src/pages/Timer/components/TimerControls/TimerControls.module.scss`:

```scss
@import '../../../../styles/variables';
@import '../../../../styles/mixins';

.timerControls {
  display: flex;
  flex-direction: column;
  gap: $spacing-xl;
}

.display {
  @include flex-center;
}

.timer {
  background: white;
  border-radius: $border-radius-2xl;
  padding: $spacing-3xl;
  border: 4px solid $color-primary;
  min-width: 300px;
  text-align: center;
  box-shadow: $shadow-xl;
  transition: all $transition-base;

  &:hover {
    transform: scale(1.02);
    box-shadow: $shadow-2xl;
  }
}

.time {
  display: block;
  font-size: 4rem;
  font-weight: $font-weight-bold;
  color: $color-gray-900;
  font-variant-numeric: tabular-nums;
  margin-bottom: $spacing-md;

  @media (max-width: $breakpoint-md) {
    font-size: 3rem;
  }
}

.projectName {
  display: block;
  font-size: $font-size-lg;
  color: $color-gray-600;
  font-weight: $font-weight-medium;
}

.controls {
  background: white;
  padding: $spacing-xl;
  border-radius: $border-radius-lg;
  box-shadow: $shadow-md;
  display: flex;
  flex-direction: column;
  gap: $spacing-lg;
}

.field {
  display: flex;
  flex-direction: column;
  gap: $spacing-sm;

  label {
    font-weight: $font-weight-medium;
    color: $color-gray-700;
  }
}

.select {
  padding: 0.75rem $spacing-md;
  border: 2px solid $color-gray-300;
  border-radius: $border-radius-md;
  font-size: $font-size-base;
  background: white;
  cursor: pointer;
  transition: all $transition-base;

  &:focus {
    outline: none;
    border-color: $color-primary;
    box-shadow: 0 0 0 3px rgba($color-primary, 0.1);
  }
}
```

Create `src/pages/Timer/components/TimerControls/index.ts`:

```typescript
export { TimerControls } from './TimerControls';
```

---

### TASK 3: Create Recent Entries Component

Create `src/pages/Timer/components/RecentEntries/RecentEntries.tsx`:

```typescript
import { useGetTimeEntriesQuery } from '@/store/api/timeEntriesApi';
import { formatDuration } from '@timeblocks/shared/utils';
import { Card } from '@/components/ui/Card';
import { Spinner } from '@/components/ui/Spinner';
import styles from './RecentEntries.module.scss';

export function RecentEntries() {
  const { data: entries = [], isLoading } = useGetTimeEntriesQuery();

  // Get last 10 entries
  const recentEntries = entries.slice(0, 10);

  if (isLoading) {
    return (
      <Card>
        <div className={styles.loading}>
          <Spinner />
          <p>Loading recent entries...</p>
        </div>
      </Card>
    );
  }

  if (recentEntries.length === 0) {
    return (
      <Card>
        <div className={styles.empty}>
          <p>No time entries yet. Start your first timer!</p>
        </div>
      </Card>
    );
  }

  return (
    <div className={styles.recentEntries}>
      <h2>Recent Entries</h2>
      <div className={styles.list}>
        {recentEntries.map((entry) => (
          <Card key={entry.id} variant="outlined" padding="md">
            <div className={styles.entry}>
              <div className={styles.info}>
                <div className={styles.description}>
                  {entry.description || 'No description'}
                </div>
                <div className={styles.meta}>
                  <span className={styles.project}>
                    {/* We'll get project name from API in real implementation */}
                    Project ID: {entry.projectId}
                  </span>
                  <span className={styles.time}>
                    {new Date(entry.startTime).toLocaleTimeString()}
                  </span>
                </div>
              </div>
              <div className={styles.duration}>
                {formatDuration(entry.duration || 0)}
              </div>
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
}
```

Create `src/pages/Timer/components/RecentEntries/RecentEntries.module.scss`:

```scss
@import '../../../../styles/variables';
@import '../../../../styles/mixins';

.recentEntries {
  h2 {
    font-size: $font-size-xl;
    margin-bottom: $spacing-lg;
    color: $color-gray-900;
  }
}

.list {
  display: flex;
  flex-direction: column;
  gap: $spacing-md;
}

.entry {
  @include flex-between;
  gap: $spacing-lg;
}

.info {
  flex: 1;
  min-width: 0;
}

.description {
  font-weight: $font-weight-medium;
  color: $color-gray-900;
  margin-bottom: $spacing-xs;
  @include truncate;
}

.meta {
  display: flex;
  gap: $spacing-md;
  font-size: $font-size-sm;
  color: $color-gray-600;
}

.project {
  display: flex;
  align-items: center;
  gap: $spacing-xs;
}

.time {
  &::before {
    content: '‚Ä¢';
    margin-right: $spacing-xs;
  }
}

.duration {
  font-size: $font-size-xl;
  font-weight: $font-weight-bold;
  color: $color-primary;
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
}

.loading,
.empty {
  @include flex-center;
  flex-direction: column;
  gap: $spacing-md;
  padding: $spacing-3xl;
  color: $color-gray-600;
}
```

Create `src/pages/Timer/components/RecentEntries/index.ts`:

```typescript
export { RecentEntries } from './RecentEntries';
```

---

### TASK 4: Create Today Stats Component

Create `src/pages/Timer/components/TodayStats/TodayStats.tsx`:

```typescript
import { useMemo } from 'react';
import { useGetTimeEntriesQuery } from '@/store/api/timeEntriesApi';
import { formatDuration, isToday } from '@timeblocks/shared/utils';
import { Card } from '@/components/ui/Card';
import styles from './TodayStats.module.scss';

export function TodayStats() {
  const { data: entries = [] } = useGetTimeEntriesQuery();

  const todayStats = useMemo(() => {
    const todayEntries = entries.filter((entry) =>
      isToday(new Date(entry.startTime))
    );

    const totalSeconds = todayEntries.reduce(
      (sum, entry) => sum + (entry.duration || 0),
      0
    );

    return {
      totalTime: formatDuration(totalSeconds),
      entriesCount: todayEntries.length,
    };
  }, [entries]);

  return (
    <div className={styles.todayStats}>
      <h2>Today</h2>
      <div className={styles.grid}>
        <Card variant="elevated" padding="lg">
          <div className={styles.stat}>
            <div className={styles.value}>{todayStats.totalTime}</div>
            <div className={styles.label}>Total Time</div>
          </div>
        </Card>

        <Card variant="elevated" padding="lg">
          <div className={styles.stat}>
            <div className={styles.value}>{todayStats.entriesCount}</div>
            <div className={styles.label}>Entries</div>
          </div>
        </Card>
      </div>
    </div>
  );
}
```

Create `src/pages/Timer/components/TodayStats/TodayStats.module.scss`:

```scss
@import '../../../../styles/variables';
@import '../../../../styles/mixins';

.todayStats {
  h2 {
    font-size: $font-size-xl;
    margin-bottom: $spacing-lg;
    color: $color-gray-900;
  }
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: $spacing-lg;
}

.stat {
  text-align: center;
}

.value {
  font-size: $font-size-3xl;
  font-weight: $font-weight-bold;
  color: $color-primary;
  margin-bottom: $spacing-xs;
  font-variant-numeric: tabular-nums;
}

.label {
  font-size: $font-size-sm;
  color: $color-gray-600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
```

Create `src/pages/Timer/components/TodayStats/index.ts`:

```typescript
export { TodayStats } from './TodayStats';
```

---

### TASK 5: Create Timer Page

Create `src/pages/Timer/Timer.tsx`:

```typescript
import { TimerControls } from './components/TimerControls';
import { TodayStats } from './components/TodayStats';
import { RecentEntries } from './components/RecentEntries';
import styles from './Timer.module.scss';

export function Timer() {
  return (
    <div className={styles.timerPage}>
      <div className={styles.header}>
        <h1>Time Tracker</h1>
        <p>Start tracking your time with one click</p>
      </div>

      <div className={styles.grid}>
        <div className={styles.main}>
          <TimerControls />
        </div>

        <div className={styles.sidebar}>
          <TodayStats />
        </div>
      </div>

      <div className={styles.recent}>
        <RecentEntries />
      </div>
    </div>
  );
}
```

Create `src/pages/Timer/Timer.module.scss`:

```scss
@import '../../styles/variables';
@import '../../styles/mixins';

.timerPage {
  max-width: 1200px;
  margin: 0 auto;
}

.header {
  margin-bottom: $spacing-xl;

  h1 {
    font-size: $font-size-3xl;
    margin-bottom: $spacing-xs;
  }

  p {
    color: $color-gray-600;
  }
}

.grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: $spacing-xl;
  margin-bottom: $spacing-xl;

  @media (max-width: $breakpoint-md) {
    grid-template-columns: 1fr;
  }
}

.main {
  // Timer controls
}

.sidebar {
  // Today stats
}

.recent {
  // Recent entries list
}
```

Create `src/pages/Timer/index.ts`:

```typescript
export { Timer } from './Timer';
```

---

### TASK 6: Update Router

Update `src/router/index.tsx` to include Timer page:

```typescript
import { createBrowserRouter, Navigate } from 'react-router-dom';
import { RootLayout } from '@/layouts/RootLayout/RootLayout';
import { AuthLayout } from '@/layouts/AuthLayout/AuthLayout';
import { ProtectedRoute } from '@/components/common/ProtectedRoute';
import { Login } from '@/pages/auth/Login';
import { Register } from '@/pages/auth/Register';
import { Dashboard } from '@/pages/Dashboard/Dashboard';
import { Timer } from '@/pages/Timer'; // Add this

export const router = createBrowserRouter([
  {
    path: '/auth',
    element: <AuthLayout />,
    children: [
      { index: true, element: <Navigate to="/auth/login" replace /> },
      { path: 'login', element: <Login /> },
      { path: 'register', element: <Register /> },
    ],
  },
  {
    path: '/',
    element: <ProtectedRoute />,
    children: [
      {
        element: <RootLayout />,
        children: [
          { index: true, element: <Dashboard /> },
          { path: 'timer', element: <Timer /> }, // Add this
          { path: 'projects', element: <div>Projects Page (Coming Soon)</div> },
          { path: 'clients', element: <div>Clients Page (Coming Soon)</div> },
          { path: 'time-entries', element: <div>Time Entries Page (Coming Soon)</div> },
          { path: 'reports', element: <div>Reports Page (Coming Soon)</div> },
          { path: 'settings', element: <div>Settings Page (Coming Soon)</div> },
        ],
      },
    ],
  },
  {
    path: '*',
    element: <Navigate to="/" replace />,
  },
]);
```

---

### TASK 7: Test the Timer

```bash
# Make sure backend is running
cd apps/server
pnpm dev

# Start frontend
cd apps/web
pnpm dev

# Open http://localhost:5173
```

**Test flow:**
1. Login/Register
2. Navigate to Timer page (click "Timer" in sidebar)
3. Select a project
4. Enter description (optional)
5. Click "Start Timer"
6. See timer counting up
7. Edit description while running
8. Click "Stop Timer"
9. See entry in recent list
10. Refresh page ‚Üí Timer should restore if running

---

## ‚úÖ Verification

### Timer Functionality
- [ ] Can select project from dropdown
- [ ] Can start timer
- [ ] Timer displays and counts up every second
- [ ] Can edit description while running
- [ ] Can stop timer
- [ ] Entry saved to backend

### Persistence
- [ ] Timer saved to localStorage on start
- [ ] Timer restored on page refresh
- [ ] Timer cleared on stop
- [ ] Description changes persist

### UI/UX
- [ ] Timer display is prominent and clear
- [ ] Project color shown in timer border
- [ ] Start/Stop buttons clearly labeled
- [ ] Recent entries show correct data
- [ ] Today stats calculate correctly
- [ ] Loading states display
- [ ] Empty states show helpful messages

### Integration
- [ ] Works with Redux
- [ ] Calls backend API correctly
- [ ] Updates RTK Query cache
- [ ] No console errors
- [ ] Responsive on mobile

---

## ‚úÖ Success Criteria

- [ ] Timer component built and working
- [ ] Redux slice handles timer state
- [ ] localStorage persistence works
- [ ] Real-time updates every second
- [ ] Backend API integration working
- [ ] Timer page looks professional
- [ ] Recent entries display correctly
- [ ] Today stats calculate accurately
- [ ] All TypeScript types correct
- [ ] No console errors

---

## üìä What We Built

```
‚úÖ Timer Redux Slice
   - Active timer state
   - Real-time updates
   - localStorage sync
   
‚úÖ Timer Components (3)
   - TimerControls (main UI)
   - RecentEntries (list)
   - TodayStats (summary)
   
‚úÖ Timer Page
   - Full layout
   - Grid structure
   - Responsive design
   
‚úÖ Features
   - Start/Stop timer
   - Real-time counting
   - Persistent across refresh
   - Backend sync
   - Project selection
   - Description editing
```

---

## ‚û°Ô∏è Next Steps

Timer feature complete! Now proceed to:
- **Sub-Agent 5.2: Projects & Clients**

---

**Timer working! ‚è±Ô∏è Time is being tracked! ‚è∞**