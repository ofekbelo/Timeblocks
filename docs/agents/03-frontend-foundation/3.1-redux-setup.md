# Sub-Agent 3.1: Redux Setup

**Parent:** Agent 3 - Frontend Foundation  
**Status:** Ready to Execute  
**Dependencies:** Agent 1 (Project Setup)  
**Estimated Time:** 2-3 hours  
**Working Directory:** `timeblocks/apps/web/`

---

## üìã Mission

Initialize a React application with Vite and set up Redux Toolkit + RTK Query for complete state management and API integration.

---

## üéØ What You'll Build

1. **Vite + React + TypeScript** - Modern React setup
2. **Redux Toolkit Store** - Centralized state management
3. **RTK Query API Slices** - Type-safe API calls
4. **Auth Slice** - Authentication state
5. **Base API** - Automatic token refresh

---

## ‚úÖ Step-by-Step Tasks

### TASK 1: Initialize Vite React Project

```bash
cd apps/web

# Initialize with Vite
pnpm create vite@latest . --template react-ts

# Answer prompts:
# - Package name: @timeblocks/web
# - Remove existing files: Yes
```

---

### TASK 2: Update package.json

Replace `apps/web/package.json` with:

```json
{
  "name": "@timeblocks/web",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "typecheck": "tsc --noEmit",
    "clean": "rm -rf dist node_modules .turbo"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.0.0",
    "@reduxjs/toolkit": "^2.0.1",
    "react-redux": "^9.0.4",
    "react-hook-form": "^7.49.3",
    "zod": "^3.22.4",
    "@hookform/resolvers": "^3.3.4"
  },
  "devDependencies": {
    "@types/react": "^18.2.48",
    "@types/react-dom": "^18.2.18",
    "@vitejs/plugin-react": "^4.2.1",
    "typescript": "^5.3.3",
    "vite": "^5.0.11",
    "sass": "^1.70.0",
    "eslint-config-custom": "workspace:*"
  }
}
```

---

### TASK 3: Install Dependencies

```bash
cd apps/web
pnpm install
```

---

### TASK 4: Configure TypeScript

Update `apps/web/tsconfig.json`:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,

    /* Path mapping */
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

Create `apps/web/tsconfig.node.json`:

```json
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
```

---

### TASK 5: Configure Vite

Create `apps/web/vite.config.ts`:

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
      },
    },
  },
});
```

---

### TASK 6: Create Environment Files

Create `apps/web/.env`:

```env
VITE_API_URL=http://localhost:3000/api
```

Create `apps/web/.env.example`:

```env
VITE_API_URL=http://localhost:3000/api
```

---

### TASK 7: Create Redux Store Structure

Create directories:

```bash
mkdir -p src/store/{api,slices}
```

---

### TASK 8: Create Base API with Token Refresh

Create `src/store/api/baseApi.ts`:

```typescript
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';
import type { RootState } from '../index';

const baseQuery = fetchBaseQuery({
  baseUrl: import.meta.env.VITE_API_URL || 'http://localhost:3000/api',
  prepareHeaders: (headers, { getState }) => {
    const token = (getState() as RootState).auth.accessToken;
    if (token) {
      headers.set('authorization', `Bearer ${token}`);
    }
    return headers;
  },
});

const baseQueryWithReauth = async (args: any, api: any, extraOptions: any) => {
  let result = await baseQuery(args, api, extraOptions);

  if (result.error && result.error.status === 401) {
    // Try to refresh token
    const refreshToken = (api.getState() as RootState).auth.refreshToken;

    if (refreshToken) {
      const refreshResult = await baseQuery(
        {
          url: '/auth/refresh-token',
          method: 'POST',
          body: { refreshToken },
        },
        api,
        extraOptions
      );

      if (refreshResult.data) {
        // Store new tokens
        const { accessToken, refreshToken: newRefreshToken } = refreshResult.data as any;
        api.dispatch({
          type: 'auth/setTokens',
          payload: { accessToken, refreshToken: newRefreshToken },
        });

        // Retry original request
        result = await baseQuery(args, api, extraOptions);
      } else {
        // Refresh failed - logout
        api.dispatch({ type: 'auth/logout' });
      }
    }
  }

  return result;
};

export const baseApi = createApi({
  reducerPath: 'api',
  baseQuery: baseQueryWithReauth,
  tagTypes: ['User', 'Client', 'Project', 'TimeEntry'],
  endpoints: () => ({}),
});
```

---

### TASK 9: Create Auth API Slice

Create `src/store/api/authApi.ts`:

```typescript
import { baseApi } from './baseApi';

export interface User {
  id: string;
  email: string;
  fullName: string;
  avatarUrl?: string;
  emailVerified: boolean;
  timezone: string;
  currency: string;
  createdAt: string;
}

export interface RegisterDto {
  email: string;
  password: string;
  fullName: string;
}

export interface LoginDto {
  email: string;
  password: string;
}

export interface AuthResponse {
  user: User;
  accessToken: string;
  refreshToken: string;
}

export const authApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    register: builder.mutation<AuthResponse, RegisterDto>({
      query: (body) => ({
        url: '/auth/register',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['User'],
    }),
    login: builder.mutation<AuthResponse, LoginDto>({
      query: (body) => ({
        url: '/auth/login',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['User'],
    }),
    logout: builder.mutation<{ message: string }, { refreshToken: string }>({
      query: (body) => ({
        url: '/auth/logout',
        method: 'POST',
        body,
      }),
    }),
    getMe: builder.query<User, void>({
      query: () => '/users/me',
      providesTags: ['User'],
    }),
  }),
});

export const {
  useRegisterMutation,
  useLoginMutation,
  useLogoutMutation,
  useGetMeQuery,
} = authApi;
```

---

### TASK 10: Create Clients API Slice

Create `src/store/api/clientsApi.ts`:

```typescript
import { baseApi } from './baseApi';

export interface Client {
  id: string;
  userId: string;
  name: string;
  email?: string;
  phone?: string;
  address?: string;
  color: string;
  notes?: string;
  isArchived: boolean;
  createdAt: string;
  updatedAt: string;
}

export interface CreateClientDto {
  name: string;
  email?: string;
  phone?: string;
  address?: string;
  color?: string;
  notes?: string;
}

export const clientsApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    getClients: builder.query<Client[], void>({
      query: () => '/clients',
      providesTags: ['Client'],
    }),
    getClient: builder.query<Client, string>({
      query: (id) => `/clients/${id}`,
      providesTags: (result, error, id) => [{ type: 'Client', id }],
    }),
    createClient: builder.mutation<Client, CreateClientDto>({
      query: (body) => ({
        url: '/clients',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['Client'],
    }),
    updateClient: builder.mutation<Client, { id: string; data: Partial<CreateClientDto> }>({
      query: ({ id, data }) => ({
        url: `/clients/${id}`,
        method: 'PATCH',
        body: data,
      }),
      invalidatesTags: (result, error, { id }) => [{ type: 'Client', id }],
    }),
    deleteClient: builder.mutation<void, string>({
      query: (id) => ({
        url: `/clients/${id}`,
        method: 'DELETE',
      }),
      invalidatesTags: ['Client'],
    }),
  }),
});

export const {
  useGetClientsQuery,
  useGetClientQuery,
  useCreateClientMutation,
  useUpdateClientMutation,
  useDeleteClientMutation,
} = clientsApi;
```

---

### TASK 11: Create Projects API Slice

Create `src/store/api/projectsApi.ts`:

```typescript
import { baseApi } from './baseApi';

export interface Project {
  id: string;
  userId: string;
  clientId?: string;
  name: string;
  hourlyRate?: number;
  estimatedBudget?: number;
  startDate?: string;
  endDate?: string;
  status: 'ACTIVE' | 'ON_HOLD' | 'COMPLETED' | 'ARCHIVED';
  color: string;
  isArchived: boolean;
  createdAt: string;
  updatedAt: string;
}

export interface CreateProjectDto {
  name: string;
  clientId?: string;
  hourlyRate?: number;
  estimatedBudget?: number;
  startDate?: string;
  endDate?: string;
  color?: string;
  status?: 'ACTIVE' | 'ON_HOLD' | 'COMPLETED' | 'ARCHIVED';
}

export const projectsApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    getProjects: builder.query<Project[], void>({
      query: () => '/projects',
      providesTags: ['Project'],
    }),
    getProject: builder.query<Project, string>({
      query: (id) => `/projects/${id}`,
      providesTags: (result, error, id) => [{ type: 'Project', id }],
    }),
    createProject: builder.mutation<Project, CreateProjectDto>({
      query: (body) => ({
        url: '/projects',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['Project'],
    }),
    updateProject: builder.mutation<Project, { id: string; data: Partial<CreateProjectDto> }>({
      query: ({ id, data }) => ({
        url: `/projects/${id}`,
        method: 'PATCH',
        body: data,
      }),
      invalidatesTags: (result, error, { id }) => [{ type: 'Project', id }],
    }),
    deleteProject: builder.mutation<void, string>({
      query: (id) => ({
        url: `/projects/${id}`,
        method: 'DELETE',
      }),
      invalidatesTags: ['Project'],
    }),
    getProjectStats: builder.query<any, string>({
      query: (id) => `/projects/${id}/stats`,
    }),
  }),
});

export const {
  useGetProjectsQuery,
  useGetProjectQuery,
  useCreateProjectMutation,
  useUpdateProjectMutation,
  useDeleteProjectMutation,
  useGetProjectStatsQuery,
} = projectsApi;
```

---

### TASK 12: Create Time Entries API Slice

Create `src/store/api/timeEntriesApi.ts`:

```typescript
import { baseApi } from './baseApi';

export interface TimeEntry {
  id: string;
  userId: string;
  projectId: string;
  description?: string;
  startTime: string;
  endTime?: string;
  duration?: number;
  isManual: boolean;
  tags: string[];
  createdAt: string;
  updatedAt: string;
}

export interface CreateTimeEntryDto {
  projectId: string;
  description?: string;
  startTime: string;
  endTime?: string;
  tags?: string[];
}

export const timeEntriesApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    getTimeEntries: builder.query<TimeEntry[], void>({
      query: () => '/time-entries',
      providesTags: ['TimeEntry'],
    }),
    getTimeEntry: builder.query<TimeEntry, string>({
      query: (id) => `/time-entries/${id}`,
      providesTags: (result, error, id) => [{ type: 'TimeEntry', id }],
    }),
    createTimeEntry: builder.mutation<TimeEntry, CreateTimeEntryDto>({
      query: (body) => ({
        url: '/time-entries',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['TimeEntry'],
    }),
    updateTimeEntry: builder.mutation<TimeEntry, { id: string; data: Partial<CreateTimeEntryDto> }>({
      query: ({ id, data }) => ({
        url: `/time-entries/${id}`,
        method: 'PATCH',
        body: data,
      }),
      invalidatesTags: (result, error, { id }) => [{ type: 'TimeEntry', id }],
    }),
    deleteTimeEntry: builder.mutation<void, string>({
      query: (id) => ({
        url: `/time-entries/${id}`,
        method: 'DELETE',
      }),
      invalidatesTags: ['TimeEntry'],
    }),
    startTimer: builder.mutation<TimeEntry, { projectId: string; description?: string }>({
      query: (body) => ({
        url: '/time-entries/start-timer',
        method: 'POST',
        body,
      }),
      invalidatesTags: ['TimeEntry'],
    }),
    stopTimer: builder.mutation<TimeEntry, void>({
      query: () => ({
        url: '/time-entries/stop-timer',
        method: 'POST',
      }),
      invalidatesTags: ['TimeEntry'],
    }),
    getActiveTimer: builder.query<TimeEntry | null, void>({
      query: () => '/time-entries/active-timer',
      providesTags: ['TimeEntry'],
    }),
  }),
});

export const {
  useGetTimeEntriesQuery,
  useGetTimeEntryQuery,
  useCreateTimeEntryMutation,
  useUpdateTimeEntryMutation,
  useDeleteTimeEntryMutation,
  useStartTimerMutation,
  useStopTimerMutation,
  useGetActiveTimerQuery,
} = timeEntriesApi;
```

---

### TASK 13: Create Auth Slice

Create `src/store/slices/authSlice.ts`:

```typescript
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import type { User } from '../api/authApi';

interface AuthState {
  user: User | null;
  accessToken: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
}

const initialState: AuthState = {
  user: null,
  accessToken: localStorage.getItem('accessToken'),
  refreshToken: localStorage.getItem('refreshToken'),
  isAuthenticated: !!localStorage.getItem('accessToken'),
};

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    setCredentials: (
      state,
      action: PayloadAction<{ user: User; accessToken: string; refreshToken: string }>
    ) => {
      state.user = action.payload.user;
      state.accessToken = action.payload.accessToken;
      state.refreshToken = action.payload.refreshToken;
      state.isAuthenticated = true;

      localStorage.setItem('accessToken', action.payload.accessToken);
      localStorage.setItem('refreshToken', action.payload.refreshToken);
    },
    setTokens: (state, action: PayloadAction<{ accessToken: string; refreshToken: string }>) => {
      state.accessToken = action.payload.accessToken;
      state.refreshToken = action.payload.refreshToken;
      state.isAuthenticated = true;

      localStorage.setItem('accessToken', action.payload.accessToken);
      localStorage.setItem('refreshToken', action.payload.refreshToken);
    },
    logout: (state) => {
      state.user = null;
      state.accessToken = null;
      state.refreshToken = null;
      state.isAuthenticated = false;

      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
    },
  },
});

export const { setCredentials, setTokens, logout } = authSlice.actions;
export default authSlice.reducer;
```

---

### TASK 14: Create UI Slice

Create `src/store/slices/uiSlice.ts`:

```typescript
import { createSlice, PayloadAction } from '@reduxjs/toolkit';

interface UiState {
  sidebarOpen: boolean;
  theme: 'light' | 'dark';
  modals: {
    [key: string]: boolean;
  };
}

const initialState: UiState = {
  sidebarOpen: true,
  theme: 'light',
  modals: {},
};

const uiSlice = createSlice({
  name: 'ui',
  initialState,
  reducers: {
    toggleSidebar: (state) => {
      state.sidebarOpen = !state.sidebarOpen;
    },
    setSidebarOpen: (state, action: PayloadAction<boolean>) => {
      state.sidebarOpen = action.payload;
    },
    setTheme: (state, action: PayloadAction<'light' | 'dark'>) => {
      state.theme = action.payload;
    },
    openModal: (state, action: PayloadAction<string>) => {
      state.modals[action.payload] = true;
    },
    closeModal: (state, action: PayloadAction<string>) => {
      state.modals[action.payload] = false;
    },
  },
});

export const { toggleSidebar, setSidebarOpen, setTheme, openModal, closeModal } = uiSlice.actions;
export default uiSlice.reducer;
```

---

### TASK 15: Configure Store

Create `src/store/index.ts`:

```typescript
import { configureStore } from '@reduxjs/toolkit';
import { setupListeners } from '@reduxjs/toolkit/query';
import { baseApi } from './api/baseApi';
import authReducer from './slices/authSlice';
import uiReducer from './slices/uiSlice';

export const store = configureStore({
  reducer: {
    [baseApi.reducerPath]: baseApi.reducer,
    auth: authReducer,
    ui: uiReducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(baseApi.middleware),
});

setupListeners(store.dispatch);

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

---

### TASK 16: Create Typed Hooks

Create `src/store/hooks.ts`:

```typescript
import { useDispatch, useSelector } from 'react-redux';
import type { RootState, AppDispatch } from './index';

export const useAppDispatch = useDispatch.withTypes<AppDispatch>();
export const useAppSelector = useSelector.withTypes<RootState>();
```

---

### TASK 17: Update Main Entry Point

Update `src/main.tsx`:

```typescript
import React from 'react';
import ReactDOM from 'react-dom/client';
import { Provider } from 'react-redux';
import { store } from './store';
import App from './App';
import './styles/global.scss';

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <Provider store={store}>
      <App />
    </Provider>
  </React.StrictMode>
);
```

---

### TASK 18: Create Basic App Component

Update `src/App.tsx`:

```typescript
import { useAppSelector } from './store/hooks';

function App() {
  const isAuthenticated = useAppSelector((state) => state.auth.isAuthenticated);

  return (
    <div className="app">
      <h1>TimeBlocks</h1>
      <p>Redux Toolkit Setup Complete!</p>
      <p>Authenticated: {isAuthenticated ? 'Yes' : 'No'}</p>
    </div>
  );
}

export default App;
```

---

### TASK 19: Create Global Styles (Basic)

Create `src/styles/global.scss`:

```scss
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html,
body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#root {
  min-height: 100vh;
}

.app {
  padding: 2rem;
}
```

---

### TASK 20: Start Development Server

```bash
cd apps/web
pnpm dev
```

**Expected output:**
```
VITE v5.0.11  ready in 500 ms

‚ûú  Local:   http://localhost:5173/
‚ûú  Network: use --host to expose
```

Open http://localhost:5173 - you should see "TimeBlocks" and "Redux Toolkit Setup Complete!"

---

## ‚úÖ Verification

### 1. Check Redux DevTools

Open browser DevTools ‚Üí Redux tab:
- Should see `auth` and `ui` slices
- Should see `api` reducer
- Try dispatching an action

### 2. Test API Integration (if backend running)

Open browser console:
```javascript
// This should work if backend is running
// We'll test properly in next sub-agent
```

### 3. Check Hot Reload

Edit `src/App.tsx` and save - page should update instantly

---

## ‚úÖ Success Criteria

- [ ] Vite + React app running
- [ ] All dependencies installed
- [ ] Redux store configured
- [ ] All API slices created
- [ ] Auth slice working
- [ ] UI slice working
- [ ] Typed hooks available
- [ ] Hot reload works
- [ ] No TypeScript errors
- [ ] Redux DevTools working

---

## üìä What We Built

```
‚úÖ React 18 + TypeScript + Vite
‚úÖ Redux Toolkit Store
‚úÖ RTK Query with 4 API slices:
   - authApi
   - clientsApi
   - projectsApi
   - timeEntriesApi
‚úÖ 2 Redux slices:
   - authSlice (user, tokens)
   - uiSlice (sidebar, modals, theme)
‚úÖ Base API with Token Refresh
‚úÖ Typed Hooks
‚úÖ Development Server Running
```

---

## ‚û°Ô∏è Next Steps

Redux is complete! Now proceed to:
- **Sub-Agent 3.2: Router & Layout**

---

**Redux setup complete! üéâ Ready for routing! üõ£Ô∏è**